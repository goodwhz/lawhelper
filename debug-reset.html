<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†ç é‡ç½®è°ƒè¯•å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">å¯†ç é‡ç½®è°ƒè¯•å·¥å…·</h1>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Supabase é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Supabase URL</label>
                    <input type="text" id="supabaseUrl" value="https://duyfvvbgadrwaonvlrun.supabase.co" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Anon Key</label>
                    <input type="password" id="supabaseKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1eWZ2dmJnYWRyd2FvbnZscnVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyODM2MjAsImV4cCI6MjA3NTg1OTYyMH0.3wExEYQ0PcdEqcML9WsvM36A74gBBXjfmmtbilwsUZ0" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                </div>
                <button onclick="initializeSupabase()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded">
                    åˆå§‹åŒ–å®¢æˆ·ç«¯
                </button>
            </div>
        </div>

        <!-- URL åˆ†æ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">é‡ç½®é“¾æ¥åˆ†æ</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é‡ç½®é“¾æ¥URL</label>
                    <textarea id="resetUrl" rows="3" placeholder="ç²˜è´´é‚®ä»¶ä¸­çš„é‡ç½®é“¾æ¥..." 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                </div>
                <button onclick="analyzeUrl()" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded">
                    åˆ†æURLå‚æ•°
                </button>
                <div id="urlAnalysis" class="mt-4 p-4 bg-gray-50 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- ä»¤ç‰Œæµ‹è¯• -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ä»¤ç‰ŒéªŒè¯æµ‹è¯•</h2>
            <div class="space-y-4">
                <button onclick="testToken()" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded">
                    æµ‹è¯•å½“å‰URLä»¤ç‰Œ
                </button>
                <div id="tokenTest" class="mt-4 p-4 bg-gray-50 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- å¯†ç é‡ç½®æµ‹è¯• -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">å¯†ç é‡ç½®æµ‹è¯•</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <button onclick="testPasswordReset()" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded">
                    æµ‹è¯•å¯†ç é‡ç½®
                </button>
                <div id="passwordTest" class="mt-4 p-4 bg-gray-50 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">è°ƒè¯•æ—¥å¿—</h2>
            <div class="space-y-2">
                <button onclick="clearLogs()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded">
                    æ¸…ç©ºæ—¥å¿—
                </button>
                <div id="debugLogs" class="mt-4 h-64 overflow-y-auto bg-black text-green-400 p-4 rounded-lg log-entry"></div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            const logsDiv = document.getElementById('debugLogs');
            
            if (data) {
                logsDiv.textContent += logEntry + JSON.stringify(data, null, 2) + '\n';
            } else {
                logsDiv.textContent += logEntry;
            }
            
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        function initializeSupabase() {
            try {
                const url = document.getElementById('supabaseUrl').value;
                const key = document.getElementById('supabaseKey').value;
                
                supabase = createClient(url, key, {
                    auth: {
                        persistSession: true,
                        storageKey: 'supabase.auth.token',
                        detectSessionInUrl: true,
                        flowType: 'pkce',
                        autoRefreshToken: true,
                        debug: true
                    }
                });
                
                log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                log('âŒ Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥', error.message);
                return false;
            }
        }

        // åˆ†æURL
        function analyzeUrl() {
            const url = document.getElementById('resetUrl').value;
            const analysis = document.getElementById('urlAnalysis');
            
            try {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                
                let analysisText = 'ğŸ” URLåˆ†æç»“æœ:\n\n';
                analysisText += `å®Œæ•´URL: ${url}\n\n`;
                analysisText += `ä¸»æœº: ${urlObj.hostname}\n`;
                analysisText += `è·¯å¾„: ${urlObj.pathname}\n\n`;
                analysisText += `å‚æ•°:\n`;
                
                for (const [key, value] of params.entries()) {
                    analysisText += `  ${key}: ${value ? 'âœ… å­˜åœ¨' : 'âŒ ç©º'}\n`;
                    if (key.includes('token') || key.includes('code')) {
                        analysisText += `    å€¼: ${value.substring(0, 20)}...\n`;
                    }
                }
                
                analysis.textContent = analysisText;
                analysis.classList.remove('hidden');
                log('URLåˆ†æå®Œæˆ', urlObj.search);
                
            } catch (error) {
                log('URLåˆ†æå¤±è´¥', error.message);
            }
        }

        // æµ‹è¯•ä»¤ç‰Œ
        async function testToken() {
            if (!supabase) {
                log('âŒ è¯·å…ˆåˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯');
                return;
            }
            
            const testDiv = document.getElementById('tokenTest');
            let result = 'ğŸ” ä»¤ç‰Œæµ‹è¯•ç»“æœ:\n\n';
            
            try {
                // è·å–URLå‚æ•°
                const params = new URLSearchParams(window.location.search);
                const accessToken = params.get('access_token');
                const refreshToken = params.get('refresh_token');
                const code = params.get('code');
                const type = params.get('type');
                
                result += `access_token: ${accessToken ? 'âœ…' : 'âŒ'}\n`;
                result += `refresh_token: ${refreshToken ? 'âœ…' : 'âŒ'}\n`;
                result += `code: ${code ? 'âœ…' : 'âŒ'}\n`;
                result += `type: ${type || 'null'}\n\n`;
                
                // å°è¯•è®¾ç½®ä¼šè¯
                if (accessToken && refreshToken) {
                    const { data, error } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    
                    if (error) {
                        result += `è®¾ç½®ä¼šè¯å¤±è´¥: ${error.message}\n`;
                    } else {
                        result += `âœ… ä¼šè¯è®¾ç½®æˆåŠŸ\n`;
                        result += `ç”¨æˆ·: ${data.user?.email}\n`;
                    }
                } else if (code) {
                    const { data, error } = await supabase.auth.exchangeCodeForSession(code);
                    
                    if (error) {
                        result += `ä»£ç äº¤æ¢å¤±è´¥: ${error.message}\n`;
                    } else {
                        result += `âœ… ä»£ç äº¤æ¢æˆåŠŸ\n`;
                        result += `ç”¨æˆ·: ${data.user?.email}\n`;
                    }
                }
                
                // è·å–å½“å‰ç”¨æˆ·
                const { data: userData, error: userError } = await supabase.auth.getUser();
                result += `\nå½“å‰ç”¨æˆ·: ${userData.user?.email || 'null'}\n`;
                if (userError) {
                    result += `è·å–ç”¨æˆ·é”™è¯¯: ${userError.message}\n`;
                }
                
            } catch (error) {
                result += `å¼‚å¸¸: ${error.message}\n`;
            }
            
            testDiv.textContent = result;
            testDiv.classList.remove('hidden');
            log('ä»¤ç‰Œæµ‹è¯•å®Œæˆ');
        }

        // æµ‹è¯•å¯†ç é‡ç½®
        async function testPasswordReset() {
            if (!supabase) {
                log('âŒ è¯·å…ˆåˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯');
                return;
            }
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const testDiv = document.getElementById('passwordTest');
            
            let result = 'ğŸ”’ å¯†ç é‡ç½®æµ‹è¯•ç»“æœ:\n\n';
            
            try {
                if (!newPassword || newPassword.length < 6) {
                    throw new Error('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                }
                
                if (newPassword !== confirmPassword) {
                    throw new Error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                }
                
                result += `æ–°å¯†ç : ${newPassword.substring(0, 3)}***\n`;
                result += `å¯†ç é•¿åº¦: ${newPassword.length}\n\n`;
                
                // å°è¯•æ›´æ–°å¯†ç 
                const { data, error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    result += `âŒ å¯†ç æ›´æ–°å¤±è´¥: ${error.message}\n`;
                    result += `é”™è¯¯ä»£ç : ${error.status}\n`;
                } else {
                    result += `âœ… å¯†ç æ›´æ–°æˆåŠŸ\n`;
                    result += `ç”¨æˆ·: ${data.user?.email}\n`;
                }
                
            } catch (error) {
                result += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
            }
            
            testDiv.textContent = result;
            testDiv.classList.remove('hidden');
            log('å¯†ç é‡ç½®æµ‹è¯•å®Œæˆ');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('debugLogs').textContent = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ å¯†ç é‡ç½®è°ƒè¯•å·¥å…·å·²åŠ è½½');
            
            // åˆ†æå½“å‰URL
            const currentUrl = window.location.href;
            if (currentUrl.includes('reset-password') || currentUrl.includes('access_token')) {
                document.getElementById('resetUrl').value = currentUrl;
                log('æ£€æµ‹åˆ°é‡ç½®é“¾æ¥ï¼Œå·²è‡ªåŠ¨å¡«å……');
            }
        });
    </script>
</body>
</html>