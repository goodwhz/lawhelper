# 前后端连接问题排查指南

## 问题诊断结果

根据测试结果，当前连接状态：

✅ **服务器** - 正常  
✅ **数据库** - 正常 (找到1条记录)  
✅ **环境配置** - 正常 (所有必需的环境变量都已设置)  
✅ **Dify AI** - 正常 (API连接正常)  

## 常见连接问题及解决方案

### 1. **端口冲突问题**
**问题：** 前端和后端使用不同端口
```
解决方案：
- 检查当前服务端口：http://localhost:3009
- 确保前端请求使用正确的端口
- 修改环境变量或重启服务
```

### 2. **CORS跨域问题**
**问题：** 前端无法访问后端API
```
解决方案：
- 检查 Next.js 配置中的 CORS 设置
- 确保API路由正确配置
- 在浏览器开发者工具中查看网络错误
```

### 3. **环境变量配置错误**
**问题：** 缺少必要的环境变量
```
解决方案：
- 检查 .env 文件是否正确配置
- 重启开发服务器使环境变量生效
- 验证 Supabase 和 Dify 的密钥
```

### 4. **数据库连接问题**
**问题：** 无法连接到 Supabase 数据库
```
解决方案：
- 验证 Supabase URL 和密钥
- 检查 RLS 策略设置
- 确认数据库表结构
```

### 5. **Dify API 连接问题**
**问题：** AI 功能无法使用
```
解决方案：
- 验证 Dify API URL 和密钥
- 检查网络连接
- 确认 Dify 服务状态
```

## 快速诊断工具

### 1. **在线诊断页面**
访问：`http://localhost:3009/connection-status`
- 实时显示所有连接状态
- 提供详细的错误信息
- 支持一键测试功能

### 2. **详细诊断页面**
访问：`connection-diagnosis.html`
- 完整的前后端连接测试
- API端点逐一验证
- 数据库和外部服务测试

### 3. **命令行测试**
```bash
# 测试服务器响应
curl http://localhost:3009/api/connection-test

# 测试数据库连接
curl -X POST http://localhost:3009/api/check-db

# 测试Dify连接
curl -X POST http://localhost:3009/api/dify/chat-mock
```

## 修复步骤

### 步骤1：检查基本连接
1. 访问 http://localhost:3009/connection-status
2. 点击"测试连接"按钮
3. 查看各个模块的状态

### 步骤2：检查API响应
1. 打开浏览器开发者工具
2. 访问 `/api/connection-test`
3. 检查网络面板中的错误

### 步骤3：检查控制台日志
1. 查看浏览器控制台错误
2. 检查服务器端日志
3. 查看网络请求失败信息

### 步骤4：重新配置环境
1. 停止开发服务器
2. 检查 .env 文件配置
3. 重启服务器：`npm run dev`

## 当前状态总结

**好消息：** 所有基础连接都正常工作！

- ✅ Next.js 服务器运行正常 (端口3009)
- ✅ Supabase 数据库连接正常
- ✅ 环境变量配置完整
- ✅ Dify AI 服务连接正常

**建议：**
1. 如果仍遇到连接问题，请清除浏览器缓存
2. 确保使用正确的端口 (3009)
3. 检查防火墙或代理设置

## 故障恢复命令

```bash
# 完全重启开发环境
cd d:\pycode\lawhelper

# 清理缓存
npm run build
rm -rf .next

# 重新启动
npm run dev
```

---

**最后更新：** 2025-12-01  
**状态：** ✅ 所有连接正常  
**当前端口：** 3009