# 法律助手登录系统使用指南

## 🚀 功能概述

本系统已成功集成了基于 Supabase 的用户认证系统，提供以下功能：

### ✅ 已实现功能

1. **用户注册与登录**
   - 邮箱密码认证
   - 密码强度验证
   - 自动邮箱验证

2. **登录弹窗系统**
   - 未登录用户点击功能模块自动弹出登录窗口
   - 优雅的模态框设计
   - 支持登录/注册/忘记密码三种模式

3. **权限管理**
   - 普通用户权限
   - 管理员权限（特殊邮箱自动识别）
   - 路由级别的权限控制

4. **用户界面**
   - 导航栏登录状态显示
   - 用户资料管理页面
   - 管理员后台页面（基础框架）

5. **错误处理**
   - 全局错误边界
   - 友好的错误提示
   - 加载状态处理

## 📋 快速开始

### 1. 创建管理员账号

访问 `http://localhost:3000/admin/init` 创建系统第一个管理员账号：

- **默认管理员邮箱**: `admin@lawhelper.com`
- **默认密码**: `Admin123!@#`
- **姓名**: `系统管理员`

### 2. 普通用户注册

在登录弹窗中选择"注册账号"，填写邮箱和密码即可完成注册。

### 3. 功能使用

- **未登录状态**: 点击任何功能模块会自动弹出登录窗口
- **已登录状态**: 可以正常使用所有功能模块
- **管理员登录**: 登录后自动跳转到后台管理页面

## 🔐 管理员邮箱配置

系统通过硬编码的邮箱列表识别管理员身份：

```typescript
const ADMIN_EMAILS = [
  'admin@lawhelper.com',
  'super@admin.com'
]
```

要添加新的管理员，需要在 `lib/auth.ts` 文件中修改 `ADMIN_EMAILS` 数组。

## 🗄️ 数据库结构

### user_profiles 表
- `id`: UUID (关联 auth.users)
- `email`: TEXT (用户邮箱)
- `name`: TEXT (用户姓名)
- `role`: TEXT (用户角色: 'user' | 'admin')
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

### 安全策略
- 用户只能查看和修改自己的资料
- 管理员可以查看和修改所有用户资料

## 🔧 技术实现

### 核心文件结构

```
├── lib/
│   ├── auth.ts                 # 认证相关函数
│   └── supabaseClient.ts       # Supabase 客户端
├── contexts/
│   └── AuthContext.tsx         # 认证上下文
├── app/components/
│   ├── auth-modal.tsx          # 登录弹窗组件
│   ├── auth-guard.tsx          # 认证守卫组件
│   ├── auth-provider-client.tsx # 认证提供者客户端
│   └── error-boundary.tsx      # 错误边界
├── app/
│   ├── admin/
│   │   ├── page.tsx            # 管理员后台
│   │   └── init/page.tsx       # 管理员初始化
│   └── profile/page.tsx        # 用户资料页
```

### 关键 Hook

1. **useAuth()**: 认证状态和用户信息
2. **useProtectedAction()**: 受保护的操作
3. **withAuth()**: 高阶组件包装器

### 认证流程

1. 用户点击需要认证的功能
2. 系统检查登录状态
3. 未登录则弹出登录弹窗
4. 用户完成登录/注册
5. 系统更新认证状态
6. 自动跳转到目标页面

## 🎨 UI/UX 特性

- **响应式设计**: 支持桌面端和移动端
- **加载状态**: 优雅的加载动画
- **错误处理**: 友好的错误提示
- **自动跳转**: 登录成功后自动跳转
- **状态持久**: 刷新页面保持登录状态

## 🔒 安全特性

1. **JWT Token**: 使用 Supabase 的 JWT 认证
2. **RLS 策略**: 数据库行级安全策略
3. **密码加密**: 客户端密码哈希
4. **会话管理**: 自动过期和刷新机制

## 🐛 故障排除

### 常见问题

1. **登录失败**
   - 检查邮箱密码是否正确
   - 确认邮箱是否已验证
   - 检查网络连接

2. **管理员权限问题**
   - 确认邮箱在管理员列表中
   - 检查数据库中的角色设置

3. **弹窗不显示**
   - 确认认证上下文正常加载
   - 检查浏览器控制台错误

4. **页面刷新后登录状态丢失**
   - 检查 Cookie 设置
   - 确认 Supabase 配置正确

### 调试模式

在开发环境中，错误边界会显示详细的错误信息，便于调试。

## 📱 移动端适配

- 登录弹窗在小屏幕上会自动调整大小
- 导航栏菜单支持触摸操作
- 所有交互元素都针对移动设备优化

## 🔄 后续开发建议

1. **功能扩展**: 为后台管理页面添加具体功能
2. **权限细化**: 实现更细粒度的权限控制
3. **社交登录**: 添加微信、QQ 等第三方登录
4. **邮件服务**: 集成邮件通知服务
5. **审计日志**: 记录用户操作日志

---

🎉 **恭喜！** 您的法律助手应用现在已经拥有了完整的用户认证系统！