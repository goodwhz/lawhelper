# 删除功能认证错误修复

## 问题描述

在删除对话时出现"用户未认证"错误：

```
Error: 用户未认证
at IntegratedChat.useCallback[deleteAllConversations]
```

## 问题原因

1. **前端未传递认证信息** - API调用时没有包含Authorization头
2. **后端未验证用户认证** - API端点没有检查用户认证状态
3. **Token缺失** - Supabase客户端的session没有正确传递到API

## 修复方案

### 1. 前端修复 (`IntegratedChat.tsx`)

#### 添加认证信息到API调用
```typescript
// 获取当前认证状态
const { data: { session } } = await supabase.auth.getSession()

if (!session) {
  throw new Error('用户未认证')
}

// 在请求头中添加认证信息
const response = await fetch('/api/conversations/batch-delete', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${session.access_token}`
  },
  body: JSON.stringify({
    conversation_ids: conversations.map(c => c.id)
  }),
})
```

#### 修复的函数
- `deleteConversation(conversationId: string)` - 单个删除
- `deleteAllConversations()` - 批量删除

### 2. 后端修复 (API端点)

#### 批量删除API (`batch-delete/route.ts`)
```typescript
// 验证用户认证
const authHeader = request.headers.get('authorization')

if (!authHeader || !authHeader.startsWith('Bearer ')) {
  return NextResponse.json(
    { error: '用户未认证' },
    { status: 401 }
  )
}

const token = authHeader.split(' ')[1]

// 验证JWT token
const { data: { user }, error } = await supabase.auth.getUser(token)

if (error || !user) {
  return NextResponse.json(
    { error: '认证失败' },
    { status: 401 }
  )
}
```

#### 单个删除API (`[conversationId]/route.ts`)
- 同样的认证验证逻辑
- 详细的错误处理和日志记录

## 修复效果

### ✅ 认证流程
1. 前端获取当前session
2. 在请求头中传递JWT token
3. 后端验证token有效性
4. 数据库函数验证用户权限

### ✅ 错误处理
- 前端：session检查 + 友好错误提示
- 后端：token验证 + 详细的错误响应
- 数据库：用户权限验证

### ✅ 安全性
- JWT token验证
- 用户身份确认
- 操作权限检查

## 修复后的流程

### 单个删除
1. 点击删除按钮 → 确认对话框
2. 获取用户session → 添加Authorization头
3. API验证token → 验证用户身份
4. 调用数据库函数 → 执行删除操作
5. 返回结果 → 更新UI状态

### 批量删除
1. 点击清空按钮 → 确认对话框
2. 获取用户session → 添加Authorization头
3. API验证token → 验证用户身份
4. 批量删除数据库函数 → 执行删除操作
5. 返回详细结果 → 更新UI状态

## 测试建议

### 1. 认证测试
- 登录状态下删除对话
- 未登录状态下的错误处理
- Token过期的情况

### 2. 功能测试
- 单个对话删除
- 批量删除所有对话
- 删除当前正在进行的对话

### 3. 错误处理测试
- 网络错误
- API错误响应
- 数据库错误

## 文件修改清单

### 前端
- `app/components/chat/IntegratedChat.tsx`
  - `deleteConversation()` 函数
  - `deleteAllConversations()` 函数

### 后端API
- `app/api/conversations/batch-delete/route.ts`
  - 添加认证验证
  - 改进错误处理
- `app/api/conversations/[conversationId]/route.ts`
  - 添加认证验证
  - 改进错误处理

## 总结

通过以下修复措施解决了认证错误：

1. **前端传递认证信息** - 在API调用中包含JWT token
2. **后端验证用户身份** - 在API端点中验证Authorization头
3. **数据库权限控制** - 通过数据库函数确保用户只能删除自己的对话
4. **完善的错误处理** - 提供清晰的错误信息和状态码

现在用户删除功能应该可以正常工作，不再出现"用户未认证"错误。