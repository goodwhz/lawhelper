<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 连接测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Supabase 连接和认证测试</h1>
    
    <div id="connection-status" class="section">
        <h3>连接状态</h3>
        <p id="status-text">正在检查连接...</p>
    </div>

    <div id="auth-section" class="section hidden">
        <h3>用户认证</h3>
        <div id="login-form">
            <h4>登录</h4>
            <input type="email" id="login-email" placeholder="邮箱" /><br>
            <input type="password" id="login-password" placeholder="密码" /><br>
            <button class="btn-primary" onclick="login()">登录</button>
            <button class="btn-secondary" onclick="showRegister()">注册</button>
            <button class="btn-secondary" onclick="showForgotPassword()">忘记密码</button>
        </div>

        <div id="register-form" class="hidden">
            <h4>注册</h4>
            <input type="text" id="register-name" placeholder="姓名（选填）" /><br>
            <input type="email" id="register-email" placeholder="邮箱" /><br>
            <input type="password" id="register-password" placeholder="密码" /><br>
            <button class="btn-primary" onclick="register()">注册</button>
            <button class="btn-secondary" onclick="showLogin()">返回登录</button>
        </div>

        <div id="forgot-form" class="hidden">
            <h4>重置密码</h4>
            <input type="email" id="forgot-email" placeholder="邮箱" /><br>
            <button class="btn-primary" onclick="resetPassword()">发送重置邮件</button>
            <button class="btn-secondary" onclick="showLogin()">返回登录</button>
        </div>

        <div id="user-info" class="hidden">
            <h4>当前用户</h4>
            <p><strong>邮箱:</strong> <span id="user-email"></span></p>
            <p><strong>用户ID:</strong> <span id="user-id"></span></p>
            <p><strong>是否管理员:</strong> <span id="user-admin"></span></p>
            <button class="btn-secondary" onclick="logout()">登出</button>
        </div>

        <div id="auth-message"></div>
    </div>

    <div id="db-section" class="section hidden">
        <h3>数据库测试</h3>
        <button class="btn-primary" onclick="testDatabase()">测试数据库连接</button>
        <div id="db-results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://duyfvvbgadrwaonvlrun.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1eWZ2dmJnYWRyd2FvbnZscnVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyODM2MjAsImV4cCI6MjA3NTg1OTYyMH0.3wExEYQ0PcdEqcML9WsvM36A74gBBXjfmmtbilwsUZ0';
        
        let supabase;
        let currentUser = null;

        // 管理员邮箱列表
        const ADMIN_EMAILS = ['admin@lawhelper.com', 'super@admin.com'];

        // 初始化 Supabase
        function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        flowType: 'implicit'
                    }
                });
                
                document.getElementById('status-text').innerHTML = '<span class="success">✅ Supabase 连接成功!</span>';
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('db-section').classList.remove('hidden');
                
                // 检查当前用户状态
                checkCurrentUser();
                
                // 监听认证状态变化
                supabase.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event, session);
                    checkCurrentUser();
                });
                
            } catch (error) {
                document.getElementById('status-text').innerHTML = `<span class="error">❌ 连接失败: ${error.message}</span>`;
            }
        }

        // 检查当前用户
        async function checkCurrentUser() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (user) {
                    currentUser = user;
                    showUserInfo(user);
                } else {
                    showLoginForm();
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
                showLoginForm();
            }
        }

        // 显示用户信息
        function showUserInfo(user) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-form').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-id').textContent = user.id;
            document.getElementById('user-admin').textContent = ADMIN_EMAILS.includes(user.email) ? '是' : '否';
        }

        // 显示登录表单
        function showLoginForm() {
            currentUser = null;
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-form').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
        }

        // 切换表单显示
        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('forgot-form').classList.add('hidden');
        }

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-form').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-form').classList.remove('hidden');
        }

        // 登录
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showMessage('请填写邮箱和密码', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showMessage(`登录失败: ${error.message}`, 'error');
                } else {
                    showMessage('登录成功!', 'success');
                    if (data.user) {
                        await upsertUserProfile(data.user);
                        showUserInfo(data.user);
                    }
                }
            } catch (error) {
                showMessage(`登录异常: ${error.message}`, 'error');
            }
        }

        // 注册
        async function register() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !password) {
                showMessage('请填写邮箱和密码', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name || ''
                        }
                    }
                });

                if (error) {
                    showMessage(`注册失败: ${error.message}`, 'error');
                } else if (data.user && !data.session) {
                    showMessage('注册成功，请查收邮件验证邮箱', 'success');
                    showLogin();
                } else if (data.user && data.session) {
                    showMessage('注册并登录成功!', 'success');
                    if (data.user) {
                        await upsertUserProfile(data.user);
                        showUserInfo(data.user);
                    }
                }
            } catch (error) {
                showMessage(`注册异常: ${error.message}`, 'error');
            }
        }

        // 重置密码
        async function resetPassword() {
            const email = document.getElementById('forgot-email').value;
            
            if (!email) {
                showMessage('请填写邮箱', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password'
                });

                if (error) {
                    showMessage(`发送重置邮件失败: ${error.message}`, 'error');
                } else {
                    showMessage('重置邮件已发送，请查收邮件', 'success');
                    showLogin();
                }
            } catch (error) {
                showMessage(`发送异常: ${error.message}`, 'error');
            }
        }

        // 登出
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    showMessage(`登出失败: ${error.message}`, 'error');
                } else {
                    showMessage('已登出', 'success');
                    showLoginForm();
                }
            } catch (error) {
                showMessage(`登出异常: ${error.message}`, 'error');
            }
        }

        // 创建或更新用户资料
        async function upsertUserProfile(authUser) {
            try {
                const isAdmin = ADMIN_EMAILS.includes(authUser.email);
                const name = authUser.user_metadata?.name || authUser.email?.split('@')[0] || '';

                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        id: authUser.id,
                        email: authUser.email,
                        name: name,
                        role: isAdmin ? 'admin' : 'user',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'id'
                    });

                if (error) {
                    console.warn('更新用户资料失败:', error);
                }
            } catch (error) {
                console.warn('用户资料操作异常:', error);
            }
        }

        // 测试数据库连接
        async function testDatabase() {
            const results = document.getElementById('db-results');
            results.innerHTML = '正在测试数据库连接...';

            try {
                // 测试查询 user_profiles 表
                const { data: profiles, error: profilesError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .limit(5);

                if (profilesError) {
                    results.innerHTML += `<br><span class="error">❌ user_profiles 表查询失败: ${profilesError.message}</span>`;
                } else {
                    results.innerHTML += `<br><span class="success">✅ user_profiles 表查询成功，找到 ${profiles.length} 条记录</span>`;
                }

                // 测试查询 law_categories 表
                const { data: categories, error: categoriesError } = await supabase
                    .from('law_categories')
                    .select('*')
                    .limit(5);

                if (categoriesError) {
                    results.innerHTML += `<br><span class="error">❌ law_categories 表查询失败: ${categoriesError.message}</span>`;
                } else {
                    results.innerHTML += `<br><span class="success">✅ law_categories 表查询成功，找到 ${categories.length} 条记录</span>`;
                }

                // 测试查询 law_documents 表
                const { data: documents, error: documentsError } = await supabase
                    .from('law_documents')
                    .select('*')
                    .limit(5);

                if (documentsError) {
                    results.innerHTML += `<br><span class="error">❌ law_documents 表查询失败: ${documentsError.message}</span>`;
                } else {
                    results.innerHTML += `<br><span class="success">✅ law_documents 表查询成功，找到 ${documents.length} 条记录</span>`;
                }

            } catch (error) {
                results.innerHTML += `<br><span class="error">❌ 数据库测试异常: ${error.message}</span>`;
            }
        }

        // 显示消息
        function showMessage(message, type) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', initSupabase);
    </script>
</body>
</html>