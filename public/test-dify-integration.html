<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify AI é›†æˆæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6">Dify AI é›†æˆæµ‹è¯•</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-2">API é…ç½®</h2>
                <div class="text-sm text-gray-600 space-y-1">
                    <div><strong>DIFY_API_URL:</strong> https://dify.aipfuture.com/v1</div>
                    <div><strong>DIFY_APP_KEY:</strong> app-eNk3GtruKTh2pHmcBk7g6gs4</div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">æµ‹è¯•æ¶ˆæ¯:</label>
                    <textarea 
                        id="testMessage" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        rows="3"
                        placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ¶ˆæ¯..."
                    >ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹åŠ³åŠ¨æ³•ç›¸å…³çš„é—®é¢˜</textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button 
                        onclick="testDifyAPI()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                    >
                        æµ‹è¯• Dify API (ç›´æ¥)
                    </button>
                    
                    <button 
                        onclick="testNextJSRoute()" 
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                    >
                        æµ‹è¯• Next.js è·¯ç”±
                    </button>
                </div>
                
                <button 
                    onclick="testStreaming()" 
                    class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
                >
                    æµ‹è¯•æµå¼å“åº”
                </button>
            </div>
            
            <div id="results" class="mt-6 space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold mb-2">æµ‹è¯•ç»“æœ:</h3>
                    <div id="output" class="text-sm font-mono whitespace-pre-wrap">ç­‰å¾…æµ‹è¯•...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DIFY_API_URL = 'https://dify.aipfuture.com/v1';
        const DIFY_APP_KEY = 'app-eNk3GtruKTh2pHmcBk7g6gs4';
        
        function updateOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-800';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        async function testDifyAPI() {
            updateOutput('=== å¼€å§‹ç›´æ¥æµ‹è¯• Dify API ===');
            const message = document.getElementById('testMessage').value;
            
            try {
                const response = await fetch(`${DIFY_API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DIFY_APP_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: {},
                        query: message,
                        response_mode: 'blocking',
                        conversation_id: null,
                        user: `test_${Date.now()}`,
                        auto_generate_name: true,
                    }),
                });

                updateOutput(`å“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    updateOutput('âœ… Dify API è°ƒç”¨æˆåŠŸ', 'success');
                    updateOutput(`å›ç­”: ${data.answer?.substring(0, 200)}...`);
                    updateOutput(`å¯¹è¯ID: ${data.conversation_id}`);
                    updateOutput(`æ¶ˆæ¯ID: ${data.id}`);
                } else {
                    const errorText = await response.text();
                    updateOutput(`âŒ Dify API è°ƒç”¨å¤±è´¥: ${errorText}`, 'error');
                }
                
            } catch (error) {
                updateOutput(`âŒ Dify API æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
            
            updateOutput('');
        }

        async function testNextJSRoute() {
            updateOutput('=== å¼€å§‹æµ‹è¯• Next.js API è·¯ç”± ===');
            const message = document.getElementById('testMessage').value;
            
            try {
                const response = await fetch('/api/dify/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: null,
                        user_id: `test_${Date.now()}`
                    }),
                });

                updateOutput(`å“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    updateOutput('âœ… Next.js è·¯ç”±è°ƒç”¨æˆåŠŸ', 'success');
                    updateOutput(`å›ç­”: ${data.answer?.substring(0, 200)}...`);
                    updateOutput(`å¯¹è¯ID: ${data.conversation_id}`);
                    updateOutput(`æ¶ˆæ¯ID: ${data.message_id}`);
                } else {
                    const errorText = await response.text();
                    updateOutput(`âŒ Next.js è·¯ç”±è°ƒç”¨å¤±è´¥: ${errorText}`, 'error');
                }
                
            } catch (error) {
                updateOutput(`âŒ Next.js è·¯ç”±æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
            
            updateOutput('');
        }

        async function testStreaming() {
            updateOutput('=== å¼€å§‹æµ‹è¯•æµå¼å“åº” ===');
            const message = document.getElementById('testMessage').value;
            
            try {
                const response = await fetch('/api/dify/chat-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: null,
                        user_id: `test_${Date.now()}`
                    }),
                });

                updateOutput(`å“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    updateOutput('âœ… æµå¼å“åº”è¿æ¥æˆåŠŸ', 'success');
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            updateOutput('ğŸ æµå¼å“åº”ç»“æŸ', 'success');
                            break;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                
                                if (data === '[DONE]') {
                                    updateOutput('ğŸ æµå¼æ•°æ®ä¼ è¾“å®Œæˆ', 'success');
                                    return;
                                }
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.answer) {
                                        fullResponse += parsed.answer;
                                        updateOutput(`ğŸ“ æ”¶åˆ°æ•°æ®: ${parsed.answer.substring(0, 50)}...`);
                                    }
                                } catch (e) {
                                    updateOutput(`âš ï¸ è§£ææ•°æ®å¤±è´¥: ${data}`, 'error');
                                }
                            }
                        }
                    }
                    
                    updateOutput(`ğŸ“„ å®Œæ•´å›ç­”: ${fullResponse.substring(0, 200)}...`);
                    
                } else {
                    const errorText = await response.text();
                    updateOutput(`âŒ æµå¼å“åº”å¤±è´¥: ${errorText}`, 'error');
                }
                
            } catch (error) {
                updateOutput(`âŒ æµå¼å“åº”æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
            
            updateOutput('');
        }

        // é¡µé¢åŠ è½½æ—¶è¾“å‡ºé…ç½®ä¿¡æ¯
        window.onload = function() {
            updateOutput('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            updateOutput(`Dify API URL: ${DIFY_API_URL}`);
            updateOutput(`App Key: ${DIFY_APP_KEY.substring(0, 10)}...`);
            updateOutput('');
        };
    </script>
</body>
</html>