<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量删除测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .button {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 10px 0;
        }
        .button:hover {
            background-color: #c82333;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>批量删除测试</h1>
    
    <div>
        <h3>测试步骤:</h3>
        <ol>
            <li>点击"获取当前会话"按钮</li>
            <li>点击"获取对话列表"按钮</li>
            <li>点击"测试批量删除"按钮</li>
        </ol>
    </div>

    <div>
        <button class="button" onclick="getCurrentSession()">获取当前会话</button>
        <button class="button" onclick="getConversations()">获取对话列表</button>
        <button class="button" onclick="testBatchDelete()">测试批量删除</button>
    </div>

    <div id="log" class="log"></div>

    <script>
        const SUPABASE_URL = 'https://duyfvvbgadrwaonvlrun.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1eWZ2dmJnYWRyd2FvbnZscnVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyODM2MjAsImV4cCI6MjA3NTg1OTYyMH0.3wExEYQ0PcdEqcML9WsvM36A74gBBXjfmmtbilwsUZ0';
        
        let currentUser = null;
        let conversations = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function getCurrentSession() {
            try {
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    log(`获取用户会话成功: ${currentUser.email} (${currentUser.id})`, 'success');
                } else {
                    log(`获取用户会话失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`获取用户会话错误: ${error.message}`, 'error');
            }
        }

        async function getConversations() {
            if (!currentUser) {
                log('请先获取用户会话', 'error');
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/conversations?user_id=eq.${currentUser.id}&order=created_at.desc`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    conversations = await response.json();
                    log(`获取对话列表成功: ${conversations.length} 个对话`, 'success');
                    conversations.forEach(conv => {
                        log(`- ${conv.id}: ${conv.title || '无标题'}`);
                    });
                } else {
                    log(`获取对话列表失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`获取对话列表错误: ${error.message}`, 'error');
            }
        }

        async function testBatchDelete() {
            if (!currentUser) {
                log('请先获取用户会话', 'error');
                return;
            }

            if (conversations.length === 0) {
                log('没有可删除的对话', 'error');
                return;
            }

            // 随机选择前2个对话进行测试删除
            const conversationIds = conversations.slice(0, 2).map(c => c.id);
            
            try {
                log(`开始批量删除测试，删除 ${conversationIds.length} 个对话`, 'info');
                log(`对话ID: ${conversationIds.join(', ')}`);

                // 使用多种认证方式
                const testMethods = [
                    {
                        name: 'Bearer Token 认证',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    },
                    {
                        name: 'X-User-ID 认证',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': currentUser.id,
                            'X-User-Email': currentUser.email
                        }
                    }
                ];

                for (const method of testMethods) {
                    log(`\n测试 ${method.name}...`, 'info');
                    
                    const response = await fetch('/api/conversations/batch-delete', {
                        method: 'POST',
                        headers: method.headers,
                        body: JSON.stringify({
                            conversation_ids: conversationIds
                        })
                    });

                    const responseText = await response.text();
                    
                    if (response.ok) {
                        const result = JSON.parse(responseText);
                        log(`${method.name} 成功: ${result.message || '删除成功'}`, 'success');
                        log(`删除数量: ${result.deleted_count || '未知'}`);
                        if (result.failed_ids && result.failed_ids.length > 0) {
                            log(`失败的ID: ${result.failed_ids.join(', ')}`, 'error');
                        }
                    } else {
                        log(`${method.name} 失败: ${response.status} ${responseText}`, 'error');
                    }
                }

            } catch (error) {
                log(`批量删除测试错误: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>