<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify API å¥åº·æ£€æŸ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6">Dify API å¥åº·æ£€æŸ¥</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold mb-4">API é…ç½®</h2>
            <div class="space-y-2 text-sm">
                <div><strong>API URL:</strong> <span id="api-url"></span></div>
                <div><strong>APP Key:</strong> <span id="app-key"></span></div>
            </div>
            
            <div class="mt-6 space-y-4">
                <button 
                    onclick="testNextJSAPI()" 
                    class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                >
                    æµ‹è¯• Next.js API è·¯ç”±
                </button>
                
                <button 
                    onclick="testDirectDifyAPI()" 
                    class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                >
                    ç›´æ¥æµ‹è¯• Dify API
                </button>
                
                <button 
                    onclick="sendTestMessage()" 
                    class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
                >
                    å‘é€æµ‹è¯•æ¶ˆæ¯
                </button>
            </div>
            
            <div id="results" class="mt-6 space-y-4"></div>
        </div>
    </div>

    <script>
        const DIFY_API_URL = 'https://dify.aipfuture.com/v1';
        const DIFY_APP_KEY = 'app-eNk3GtruKTh2pHmcBk7g6gs4';

        // æ˜¾ç¤ºé…ç½®
        document.getElementById('api-url').textContent = DIFY_API_URL;
        document.getElementById('app-key').textContent = DIFY_APP_KEY.substring(0, 15) + '...';

        function addResult(title, content, isSuccess = true) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `p-4 rounded-lg ${isSuccess ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
            resultDiv.innerHTML = `
                <h3 class="font-semibold ${isSuccess ? 'text-green-800' : 'text-red-800'}">${title}</h3>
                <pre class="mt-2 text-sm whitespace-pre-wrap ${isSuccess ? 'text-green-700' : 'text-red-700'}">${content}</pre>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        async function testNextJSAPI() {
            try {
                const response = await fetch('/api/health-check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… Next.js API æˆåŠŸ', JSON.stringify(data, null, 2), true);
                } else {
                    addResult('âŒ Next.js API å¤±è´¥', `çŠ¶æ€ç : ${response.status}\n${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                addResult('âŒ Next.js API å¼‚å¸¸', error.message, false);
            }
        }

        async function testDirectDifyAPI() {
            try {
                const response = await fetch(`${DIFY_API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DIFY_APP_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: {},
                        query: 'ä½ å¥½ï¼Œè¯·ç®€å•å›å¤ä¸€ä¸‹',
                        response_mode: 'blocking', // ä½¿ç”¨blockingæ¨¡å¼è¿›è¡Œç®€å•æµ‹è¯•
                        user: 'health_check_user',
                    }),
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… Dify API ç›´æ¥è¿æ¥æˆåŠŸ', JSON.stringify(data, null, 2), true);
                } else {
                    addResult('âŒ Dify API ç›´æ¥è¿æ¥å¤±è´¥', `çŠ¶æ€ç : ${response.status}\n${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                addResult('âŒ Dify API è¿æ¥å¼‚å¸¸', error.message, false);
            }
        }

        async function sendTestMessage() {
            try {
                const response = await fetch('/api/chat-messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: {},
                        query: 'ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ çš„åŠŸèƒ½',
                        response_mode: 'blocking', // å…ˆç”¨blockingæ¨¡å¼æµ‹è¯•
                        user: 'test_user',
                        auto_generate_name: true,
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('âŒ å‘é€æ¶ˆæ¯å¤±è´¥', `çŠ¶æ€ç : ${response.status}\n${errorText}`, false);
                    return;
                }

                // å¯¹äºblockingæ¨¡å¼ï¼Œç›´æ¥è§£æJSON
                const data = await response.json();
                addResult('âœ… å‘é€æ¶ˆæ¯æˆåŠŸ', JSON.stringify(data, null, 2), true);

            } catch (error) {
                addResult('âŒ å‘é€æ¶ˆæ¯å¼‚å¸¸', error.message, false);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            addResult('ğŸ“‹ æ£€æŸ¥å¼€å§‹', 'æ­£åœ¨éªŒè¯ Dify API é…ç½®å’Œè¿æ¥...', true);
        });
    </script>
</body>
</html>