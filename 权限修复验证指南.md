# 用户资料更新权限修复验证指南

## 修复内容

已修复 "permission denied for table users" 错误，具体修复如下：

### 1. 简化 RLS 策略
删除了所有复杂的 RLS 策略，创建了一个简单的全功能策略：
```sql
CREATE POLICY "Users can manage own profile" ON public.user_profiles
    FOR ALL USING (auth.uid() = id) WITH CHECK (auth.uid() = id);
```

### 2. 优化更新逻辑
修改了 `updateUserProfile` 函数：
- 先尝试更新现有记录
- 如果失败（记录不存在），则插入新记录
- 同时更新 Supabase Auth 的用户元数据作为备份

### 3. 修复全局用户名显示
- 更新了 AuthContext 中的用户信息获取逻辑
- 修复了聊天组件中的用户名显示问题

## 验证步骤

### 方法一：使用测试页面
1. 打开 `test-profile-update.html`
2. 登录您的账户
3. 输入新姓名并点击"更新资料"
4. 检查结果和当前用户信息

### 方法二：在主应用中测试
1. 登录到您的账户
2. 访问 `/profile` 页面
3. 修改姓名并保存
4. 检查以下位置是否显示新用户名：
   - 导航栏右上角
   - 个人资料页面
   - 聊天界面的用户头像

## 预期结果

✅ **成功标志：**
- 更新时无权限错误
- 新用户名在所有位置正确显示
- 数据库中的 `user_profiles` 表被正确更新

❌ **失败标志：**
- 控制台显示 "permission denied" 错误
- 用户名只在部分页面更新
- 更新后显示错误信息

## 故障排除

如果仍有问题：

1. **检查浏览器控制台**
   - 是否还有权限错误
   - 网络请求是否成功

2. **验证用户登录状态**
   - 确保用户已正确登录
   - 检查 `auth.uid()` 是否返回正确的用户ID

3. **数据库直接验证**
   ```sql
   SELECT * FROM public.user_profiles WHERE id = 'your-user-id';
   ```

## 技术细节

### RLS 策略解释
- `FOR ALL`: 适用于所有操作（SELECT, INSERT, UPDATE, DELETE）
- `USING (auth.uid() = id)`: 用户只能操作自己的记录
- `WITH CHECK (auth.uid() = id)`: 用户只能插入/更新自己的记录

### 更新流程
1. 前端调用 `updateUserProfile()`
2. 尝试 UPDATE 现有记录
3. 如果失败，尝试 INSERT 新记录
4. 同时更新 Supabase Auth 元数据
5. 调用 `refreshUser()` 更新全局状态

现在用户资料更新应该可以正常工作了！